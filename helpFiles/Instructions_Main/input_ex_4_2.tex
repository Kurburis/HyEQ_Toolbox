\label{ex:EstimationOverNetwork}
\begin{figure}
  \begin{center}
    {\includegraphics[width=1.0\textwidth]{figures/Simulink/NetworkExample.eps}}
   \caption{Estimation over a network scheme in Example~\ref{ex:Estimation}.}
\label{fig:NetworkExample}
  \end{center}
\end{figure}

\begin{example}{Estimation Over a Network}\label{ex:Estimation}
Consider a physical process given in terms of the state-space model
\begin{equation}
\begin{aligned}
\label{eqn:PlantForEstimation}
&\xpdot=A \xp ,\qquad 
&\yp= M \xp, \qquad & \xp \in \reals^{n_P}, \yp \in \reals^{r_P}
\end{aligned}
\end{equation}
where $\xp$ is the state and $y$ is the measured output.
The output is digitally transmitted through a network.
At the other end of the network, a computer receives the information
and runs an algorithm that takes the measurements of 
$\yp$ to estimate the state $\xp$ of the physical process.
In Figure~\ref{fig:NetworkExample} the scheme of the simulation is presented.
We consider an estimation algorithm with a state variable $\hat\xp \in \reals^{n_P}$,
which denotes the estimate of $\xp$, that is appropriately reset
to a new value involving the information received.
More precisely, denoting the transmission times by $t_i$
and $L$ a constant matrix to be designed,
the estimation algorithm updates its state as follows
\begin{equation}\label{eqn:HatXpUpdateExample}
\hat\xp^+=\hat\xp+L(\yp-M\hat\xp)
\end{equation}
at every instant information is received.
In between such events, the algorithm
updates its state continuously so as to match the evolution
of the state of the physical process, that is, via
\begin{equation}\label{eqn:HatXpFlowsExample}
\dot{\hat\xp} = A \hat\xp
\end{equation}
Modeling the network as a hybrid system,
which, in particular, assumes zero transmission delay,
the state variables of the entire system are 
$j_N$, $\tau_N \in \reals$, $m_N \in \reals^{r_P}$, and $\xp,\ \hat\xp\in \reals^{n_P}$.  
Then, transmissions occur when $\tau_N \leq 0$, 
at which events the state of the network is updated via
$$
\tau_N^+ \in [T^{*\min}_{N},T^{*\max}_{N}],\quad j_N^+ = j_N+1, \qquad m_N^+ = \yp
$$
and the state of the algorithm is updated via \eqref{eqn:HatXpUpdateExample}.
Note that since the state of the physical process does not change at such
events, we can use the following trivial difference equation to update it at the
network events:
$$
\xp^+ = \xp
$$
In between events, the state of the network is updated as
$$
\dot{\tau}_N = -1, \qquad \dot{j}_N, \qquad \dot{m}_N = 0
$$
the state of the algorithm changes continuously according to \eqref{eqn:HatXpFlowsExample}, and the 
state of the physical process changes according to \eqref{eqn:PlantForEstimation}.
Considering the equations above, we arbitrarily pick the following data for each of the subsystems in Figure~\ref{fig:NetworkExample}:

\begin{itemize}
\item Physical process:
\begin{eqnarray}
\fp(\xp, u):= A\xp + Bu,\ 
   \Cp : = \Re^{n_p}\times\Re\\
\gp(\xp, u):= \xp,\ 
    \Dp: =\emptyset,\ 
\yp = h(\xp) : =M\xp
\end{eqnarray}
where 
\begin{align}
A = 
\begin{bmatrix} 
0&1&0&0\\
-1&0&0&0\\
-2&1&-1&0\\
2&-2&0&-2
\end{bmatrix},\quad
B = \begin{bmatrix} 0\\0\\0\\0 \end{bmatrix},\quad
M = \begin{bmatrix}1&0&0&0\end{bmatrix},
\end{align}
$n_p=4$, $r_p=1$, $\xp \in\Re^{n_p}$, $\yp\in\Re^{r_p}$, and $u\in\Re$.

\item Network: 

\begin{align}
f(x_N, u_N)&:= \begin{bmatrix}
0\\0\\-1
\end{bmatrix},\ 
   &C &:= \defset{(x_N,u_N)}{ \tau_N \geq 0 },\\
g(x_N, u_N)&:= \begin{bmatrix}
u_N\\
j_N+1\\
\tau_r
\end{bmatrix},\ 
    &D &:=\defset{(x_N,u_N)}{ \tau_N \leq 0 },\quad 
y_N = h(x_N) : =x_N
\end{align}
where 
$\tau_r\in[T^{*\min}_{N},T^{*\max}_{N}]$ is a random variable that models the time in-between communication instances. Also, the sate and the input are given by $x_N=(m_N,j_N,\tau_N)\in\Re\times\Re\times\Re$, and $u_N=\yp\in\Re^{r_p}$, respectively.
\item Estimator:
\begin{align}
f(x_E, u_E)&:= 
\begin{bmatrix}
A &0 \\ 0 & 0
\end{bmatrix}x_E + \begin{bmatrix}
B\\0
\end{bmatrix}v,\ 
   &C &:= \defset{(x_E,u_E)}{ j_E = j_N },\\ 
g((\hat{x},j_E), u_E)&:= \begin{bmatrix}
\hat{x} + L(m_N-M\hat{x})\\
j_N
\end{bmatrix},\ 
    &D &:=\defset{(x,u)}{ j_E\in\nats\setminus j_N},
\end{align}
where $L$, which is designed as in~\cite{FGST16}, is given by
\begin{align}
L &:= \begin{bmatrix} 1\\ -0.9433\\ -0.6773\\1.6274\end{bmatrix},
\end{align}
the input and the state are given by $u_E = (x_N,v) = ((m_N,j_N,\tau_N),v)\in\Re\times\Re\times\Re\times\Re$, and $x_E=(\hat{x},j_E)\in\Re^{4}\times\Re$, respectively. Notice that the estimator block (Estimator) in Figure~\ref{fig:NetworkExample} is implemented using a regular hybrid system block with embedded functions.

\end{itemize}

%\begin{eqnarray}
%f(x, u):= ,\ 
%   C : = \defset{(x,u)}{ },\\
%g(x, u):= ,\ 
%    D: =\defset{(x,u)}{ },\ 
%y = h(x) : =x
%\end{eqnarray}


For each hybrid system in Figure~\ref{fig:NetworkExample} (HSu, network, and Estimator) we have the following Matlab embedded functions that describe the sets $C$ and $D$ and functions $f$ and $g$.
Figure~\ref{fig:Net-Est} depicts the corresponding hybrid arc for the position state.

\begin{figure}[ht]
  \begin{center}
    \includegraphics[width=0.8\textwidth]{figures/Simulink/ResultsNetworkEstimator1.eps}
   \caption{Estimated states Vs. continuous plant states}
\label{fig:Net-Est}
  \end{center}
\end{figure}

% Set the location for MATLAB files included via the "\code" command.
\codeLocation{Matlab2tex_CPS_Network_1}

\begin{itemize}
\item Continuous process:

\code{f.m}
\code{C.m}
\code{g.m}
\code{D.m}

% Flow map
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/f.tex}\label{scr:f}
% %\normalsize

% Flow set
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/C.tex}\label{scr:C}
% %\normalsize

% Jump map
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/g.tex}\label{scr:g}
% %\normalsize

% Jump set
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/D.tex}\label{scr:D}
% %\normalsize

\item Network:

\code{f\_network.m}
\code{C\_network.m}
\code{g\_network.m}
\code{D\_network.m}

% Flow map
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/f_network.tex}\label{scr:f}
% %\normalsize

% Flow set
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/C_network.tex}\label{scr:C}
% %\normalsize

% Jump map
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/g_network.tex}\label{scr:g}
% %\normalsize

% Jump set
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/D_network.tex}\label{scr:D}
% %\normalsize

\item Estimator:

% \code{f\_Estimator.m}
{\color{red} NOTE: "f\_Estimator.m" and "g\_Estimator.m" do not exist, for some reason.}
\code{C\_Estimator.m}
% \code{g\_Estimator.m}
\code{D\_Estimator.m}

% Flow map
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/f_Estimator.tex}\label{scr:f}
% %\normalsize

% Flow set
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/C_Estimator.tex}\label{scr:C}
% %\normalsize

% Jump map
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/g_Estimator.tex}\label{scr:g}
% %\normalsize

% Jump set
% %\scriptsize
% \input{Matlab2tex_CPS_Network_1/D_Estimator.tex}\label{scr:D}
%\normalsize
\end{itemize}

\end{example}